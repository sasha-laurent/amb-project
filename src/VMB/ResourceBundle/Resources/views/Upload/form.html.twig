{% set stripBodyHeader = true %}
{% extends "::Backend/subPage.html.twig" %}
{% form_theme form 'bootstrap_3_horizontal_layout.html.twig' %}

{% block header %}
<form action="#" method="post" id="modal_res_add" class="form-horizontal" {{ form_enctype(form) }}>
<h3 class="page-header" style="margin-top:20px;padding-bottom:20px">
	{% if backButtonUrl is defined %}
	<a title="{{"actions.back"|trans}}" class="btn btn-default" href="{{ backButtonUrl }}" >
		<span class="left glyphicon glyphicon-chevron-left" aria-hidden="true" >
		</span>
	</a>
	{% endif %}
	{{mainTitle}}
	<div class="btn-group pull-right">
		<button id="modal_save_btn" type="submit" title="Save" class="btn btn-default">
			<span class="glyphicon glyphicon-floppy-open"></span>
		</button>
		{% if is_modal is defined %}
		<button type="button" title="Discard" class="btn btn-default" data-dismiss="modal">
			<span class="glyphicon glyphicon-remove"></span>
		</button>
		{% endif %}
	</div>
	<span id="modal_loading" style="margin-right:10px;margin-top:9px" class="loading_indicator_inline pull-right"></span>
</h3>
{% endblock %}

{% block body %}
	<div class="well" style="margin-bottom:10px;padding-bottom:9px;">
		<div class="form-group">{{form_label(form.title)}}<div class="col-sm-10">{{form_widget(form.title)}}</div></div>
		<div class="form-group">{{form_label(form.description)}}<div class="col-sm-10">{{form_widget(form.description)}}</div></div>
		<div class="form-group">{{form_label(form.keywords)}}<div class="col-sm-10">{{form_widget(form.keywords)}}</div></div>
		<div class="form-group">{{form_label(form.topic)}}<div class="col-sm-10">{{form_widget(form.topic)}}</div></div>
		{% if form.file is defined %}
			<div class="form-group">{{form_label(form.file)}}<div class="col-sm-10" style="margin-top:5px;">{{form_widget(form.file)}}</div></div>
		{% endif %}
		{{dump(resource)}}
		{% if resource.id is null or 
			(resource.id is not null and resource.type == "audio") %}
			<div class="row">
				{{form_label(form.customAudioArt)}}
			{% if resource.hasCustomArt() %}
					<div class="col-sm-4 col-sm-offset-2">
					<img src="{{ asset(resource.getCustomArtPath) }}" id="customArt_thumb" title="{{ 'form.label.current_thumbnail'|trans }}" style="height: 155px; width: 205px;"/> 
						<button class="btn btn-default" id="delete_thumbs" type="button" role="button">
							<span class="glyphicon glyphicon-remove"></span>
						</button>
					</div>
			{% endif %}
					<div class="col-sm-4">
						<div style="margin-top:5px;">
					{{form_widget(form.customAudioArt)}}
						</div>
					</div>
			</div>
		{% endif %}
	</div>
{% if resource.hasCustomArt %}
	<input type="hidden" name="keepThumbs" id="keepThumbs" value="1"/>
{% endif %}
	    {{ form_widget(form._token) }}
</div>
</form>
{% endblock %}

{% block script %}
{% if is_modal is not defined %}
	{{parent()}} {# Import jQuery (+UI), Bootstrap #}
{% endif %} 
	
<script type="text/javascript">
{# Ajax logic #}
{% if is_modal is defined %}

$(document).ready(function(){
	$("#modal_res_add").on('submit', function(evt){

		/*
		** Prevent automatic form submit
		*/
		evt.stopPropagation();
		evt.preventDefault();

		/*
		** Serialize Data
		*/
		var formData = new FormData();
		var form_fields = $(this).serializeArray();
		jQuery.each(form_fields, function(i, field_obj){
			formData.append(field_obj.name, field_obj.value);
		});
		var file_selector = $("#vmb_resourcebundle_resource_file")[0].files[0];
		formData.append("vmb_resourcebundle_resource[file]", file_selector);

		/*
		** Actually make the Ajax call and implement response handlers
		*/
		$.ajax({
			url: "{{path('resource_new')}}",
			method: "POST",
			data: formData,
			beforeSend: function(){
				$("#modal_loading").css('display', 'inline-block');
			},
			complete: function(){
				$("#modal_loading").css('display', 'none');				
			},
			success: function(data, textStatus, jqXHR){
				$("#modal_save_btn").removeClass("btn-default").addClass("btn-info");
				$("#modal_save_btn > span").removeClass("glyphicon-floppy-open").addClass("glyphicon-floppy-saved");
				setTimeout(function(){ // Hide modal and revert classes for next resource add
					$("#modalResourceAdd").modal('hide');
					$("#modal_save_btn > span").removeClass("glyphicon-floppy-saved").addClass("glyphicon-floppy-open");
					$("#modal_save_btn").removeClass("btn-info").addClass("btn-default");
				}, 500);
				var msg_type = "success";
				if(data.success == true)
				{
					/* Make the resource available immediately in the personal file list
					 *
					 * TODO: Check if the resource's topic is coherent with the matrix' topic
					 * an even better choice would be to highlight the matrix' topic in the
					 * modal resource add so that the user doesn't have to fill it himself.
					*/
					var r = data.resource;
					var _id = data.rid;
					if(r != null && _id != '' && _id != null)
					{ // Resource is defined in ajax response
						var file_list = $("#collapseListGroup_personal_image > ul");
						$(file_list).prepend('<li class="list-group-item addableResource addableRes_'+_id+' ui-draggable ui-draggable-handle" data-resource="'+_id+'" data-title="'+r.title+'" data-thumb="'+r.src+'"><div class="row"><div class="col-sm-10">'+r.title+'</div><div class="col-sm-2"></div></div></li>');
						resourcesCollection[_id] = r; // Insert it in our data object
						// Make it clickable
						$('.addableRes_'+_id).on('click', function(){
							triggerNewRes(_id);
						});
					} else {
						//console.log(r, _id);
					}
				} else { // Failed to persist the data
					msg_type = "danger";
				}
				// Display response message
				$('.drag_container').before('<div class="alert alert-'+msg_type+' col-sm-6 col-sm-offset-3 alert-dismissible fade in" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>'+data.message+'</div>');
			},
			error: function(jqXHR, textStatus, errorThrown){
				// console.log(data, textStatus, errorThrown);
				$("#modal_save_btn").removeClass("btn-default").addClass("btn-danger");				
				setTimeout(function(){
					$("#modalResourceAdd").modal('hide');
					$("#modal_save_btn").removeClass("btn-danger").addClass("btn-default");
				}, 500);
				$('.drag_container').before('<div class="alert alert-danger col-sm-6 col-sm-offset-3 alert-dismissible fade in" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>'+textStatus+'</div>');
			},
			/*
			** jQuery options
			** contentType is "multipart/form-data"
			** but we set it to defined or jQuery auto-setting gets it wrong
			*/
			contentType: false, 
			cache: false,
			processData: false
		});
	});
});
{% endif %}

// Defining some selectors that will come in handy 
var file_form = $("#vmb_resourcebundle_resource_file");
var thumbnail_row = $("#vmb_resourcebundle_resource_customAudioArt").parentsUntil(".well")[2];
var thumbnail_form = $("#vmb_resourcebundle_resource_customAudioArt").parentsUntil(".row")[1];

{% if resource.hasCustomArt() %}
{# TODO: Manage thumb deletion with confirmation and then ajax request.#}
	$('#delete_thumbs').click(function(event) {
		event.preventDefault();
		$('#keepThumbs').val(0);
		$(this).parent().hide();
		$(thumbnail_form).show();
	});
	var hasCustomArt = true;
{% else %}
	var hasCustomArt = false;
{% endif %}

	$(document).ready(function(){
		if(file_form.length != 0) 
		{	// File upload form is actually defined.
			// Initially hide optional thumbnail input
			$(thumbnail_row).hide();
			// when a file has been selected, parse extension, if it corresponds to an audio file then reveal audio art upload 
			$(file_form).change(function(){
				var selected_file = $(this)[0].files[0];
				// don't exclude the possibility that nothing was selected
				if(selected_file != null) 
				{
					var typ = selected_file.type.split('/');
					// show the form if an audio file was selected
					if(typ[0] == 'audio' && 
						(typ[1] == 'ogg' || typ[1] == 'mp3'))
					{
						$(thumbnail_row).show();
					}
				}
			});
		} else if(hasCustomArt)
		{
			$(thumbnail_form).hide();
		}
	});
</script>
{% endblock %}

